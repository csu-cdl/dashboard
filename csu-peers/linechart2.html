<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Line Chart</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="assets/peercomp.css">
<style type="text/css">
${demo.css}
</style>
<style>
* {
padding:0;
margin:0;
}
#controls fieldset {
border:none;
max-width:900px;
height:30px;
padding:10px;
background:#eee;
margin:20px;
}
#multiline_chart_container {
position:relative;
float:left;
min-width:310px;
max-width:600px;
width:600px;
height:400px; 
margin:0 auto;
}
#chart_panel_0 {
position:relative;
min-width:900px;
height:400px;
margin:20px;
}
#text_panel_0 {
position:relative;
float:left;
width:280px;
height:300px;
margin-top:50px;
overflow:auto;
background:#fff;/*#f7fcff;*/
border:1px solid #ccc;
border-radius: 2px;
box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
font-family:sans-serif;
font-size:12px;
}
#text_panel_0 h3 {
display:block;
font-size:12px;
text-align:center;
width:230px;
font-weight:600;
margin:20px auto;
}
#text_panel_0 table {
margin:20px;
}
#text_panel_0 table tr td {
font-size:10px;
font-weight:400;
margin: 10px;
width:115px;
padding:5px;
}
#text_panel_0 table tr td+td {
text-align:right;
}

</style>
<script type="text/javascript">
$(function () {
	var create_chart = function (config, data) {
    $('#multiline_chart_container').highcharts({
        title: {
            text: 'Grad Rate Trend',
            x: -20 //center
        },
        subtitle: {
            text: '',
            x: -20
        },
        xAxis: {
            categories: config.years //['2000', '2001', '2002', '2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010']
        },
        yAxis: {
            title: {
                text: ' % Grad Rate'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: '%'
        },
        legend: {
            layout: 'horizontal',
            align: 'center',
	    width:200,
            borderWidth: 0
        },
        series: data
    });
};
var json_data = [{
            name: 'CSU-Bakersfield',
            data: [60, 60.1, 60.9, 62, 60, 61, 63, 64, 62, 63, 62]
        }, {
            name: 'Texas A & M University-Corpus Christi',
            data: [62, 63.1, 62.9, 63, 62, 61, 62, 64, 66, 62, 64]
        }, {
            name: 'CUNY John Jay College of Criminal Justice',
            data: [65, 66.1, 64.9, 63, 63, 62, 62, 63, 64, 65, 64]
        }, {
            name: 'Austin Peay State University',
            data: [62, 64.1, 64.9, 63.4, 64, 65.1, 63.7, 64.3, 65, 65, 65.5]
        }, {
            name: 'Northeastern State University',
            data: [60, 61.1, 61.9, 62, 60.1, 61.3, 62.4, 62.1, 63, 62, 63]
        }];
	var years = {'4yr':['2000', '2001', '2002', '2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010'],
			'6yr':['2000', '2001', '2002', '2003', '2004', '2005', '2006', '2007', '2008']};
	var map_years = {'5':-5,'3':-3,'0':0}; // modify to match returned values from control 
	var retained_json_data; // saves having to reload data each time only year_span changes
	// default configuration
	var config = {'campus':'Bakersfield', 'years':years['6yr'].slice(map_years[3]), 'peer_count':5, 'type':'GR', 'grad_year':'6yr','option':'3'};

	// only show year_span of series (series array is sliced at position)
	var truncate_data = function (data, position) {
		var out = [], item, key, itemset;
		for (var i = 0, ilen = data.length; i < ilen; i++) {
			itemset = {};
			for (key in data[i]) {
				if (data[i].hasOwnProperty(key)) {
					item = data[i][key];
					if (key === 'data') {
						itemset[key] = item.slice(map_years[position]);
					} else {
						itemset[key] = item;
					}
				}
			} 
			out.push(itemset);
		}
		return out;
	};

	// fetch appropriate data set
	var load_chart_data = function (config, callback) {
		var match_pattern = / /g;
		var chart_data_src = 'data/' + config.type + config.grad_year + '/' + 
			config.campus.replace(match_pattern,'_') + '_' + config.grad_year + config.type + '.json?v=17';

		// fetch json data via xhr, then invoke callback
		$.ajax({
			url: chart_data_src,
			datatype: "json",
			success: function (result) {
				var json_object = (typeof result === 'string') ? JSON.parse(result) : result;
				callback(json_object, config);
			},
			error: function (xhr, msg, e) {
				console.log(msg);
			}
		});
	};

	// select appropriate subset of peers
	var filter_peers = function (config, json_data) {
		var rows = json_data.rows;
		var out_data = [];
		var selected_campus_data;
		for (var i = 0, ilen = rows.length, row; i < ilen; i++) {
			row = rows[i];
			name = row[0];
			series = row.slice(1);
			series.forEach(function (item, j, a) {
				a[j] = parseFloat(item);
			});
			if ((name === 'California State University-' + config.campus || 
					name === 'California ' + config.campus || 
					name === 'California State Polytechnic University-' + config.campus || 
					name === config.campus + ' State University')) {
				selected_campus_data = {'name':name,'data':series};
			} else {
				out_data.push({'name':name,'data':series});
			}
		}
		out_data.sort(function (a,b) {
			return a.data.slice(-1)-b.data.slice(-1);
		});
		var out_data_subset = out_data.slice(1-config.peer_count);
		out_data_subset.sort(function (a,b) {
			return a.name>b.name?1:a.name===b.name?0:-1;
		});
		out_data_subset.unshift(selected_campus_data);
		return out_data_subset;
	};

	var generate_summary_text = function (peer_subset) {
		//console.log(JSON.stringify(peer_subset));
		var year_start, year_end, n;
		year_start = 2006;
		year_end = 2008;
		n = 6;
		var heading = year_start + '-' + year_end + ' Average Annual Improvement in ' + n + '-Year Graduation Rates';
		var detail = '<table><tbody>';
		for (var i = 0, ilen = peer_subset.length, line, avg; i < ilen; i++) {
			avg = 0; // avoid divide by zero
			if (peer_subset[i].data.length) {
				//console.log(JSON.stringify(peer_subset[i].data));
				//console.log(JSON.stringify(peer_subset[i].data.slice(-1)[0]));
				//console.log(JSON.stringify(peer_subset[i].data[0]));
				//console.log(JSON.stringify(peer_subset[i].data.length));
				//console.log(peer_subset[i].data.slice(-1)[0] - peer_subset[i].data[0]);
				avg = Math.round(100.0 * (peer_subset[i].data.slice(-1)[0] - peer_subset[i].data[0]) / peer_subset[i].data.length)/100.0;
			}
			line = '<tr><td>' + peer_subset[i].name + '</td><td>' + avg + ' percentage points</td></tr>';
			detail += line;
		}
		detail += '</tbody></table>';
		return '<h3>' + heading + '</h3>' + detail;
	};
/*
2006-2008 Average Annual Improvement in 6-Year Graduation Rates
•	CSU Stanislaus = 1.2 percentage points
•	Kean University  = 1.1 percentage points
•	University Texas = 0.9 percentage points
•	University Delaware = 0.6 percentage points
*/

	var text_panel_0 = document.querySelector('#text_panel_0');
	// update the chart
	var update_multiline_chart = function (config, json_data) {
		var peer_subset = filter_peers(config, json_data);
		//console.log(JSON.stringify(config));
		//console.log(JSON.stringify(peer_subset));
		create_chart(config, truncate_data(peer_subset, config.years.length));
		text_panel_0.innerHTML = generate_summary_text( truncate_data(peer_subset, config.years.length));
	};

	// respond to user changes of year_span
	var year_span_selector = document.querySelector('#year_span_selector');
	year_span_selector.addEventListener('change', function (e) {
		config.option = e.target.value;
		config.years = years[config.grad_year].slice(map_years[config.option]);
		//console.log(JSON.stringify(config));
		update_multiline_chart(config, retained_json_data);
	}, false);

	// respond to user changes of campus
	var campus_selector = document.querySelector('#campus_selector');
	campus_selector.addEventListener('change', function (e) {
		config.campus = e.target.value;
		//console.log(JSON.stringify(config));
		load_chart_data(config,  function (json_data, config) {
			retained_json_data = json_data;
			update_multiline_chart(config, retained_json_data);
		});
	}, false);

	var year_selector = document.querySelector('#year_selector');
	year_selector.addEventListener('change', function (e) {
		config.grad_year = e.target.value;
		config.years = years[config.grad_year].slice(map_years[config.option]);
		//console.log(JSON.stringify(config));
		load_chart_data(config,  function (json_data, config) {
			retained_json_data = json_data;
			update_multiline_chart(config, retained_json_data);
		});
	}, false);

	// initialize chart with default config
	load_chart_data(config, function (json_data, config) {
		retained_json_data = json_data;
		update_multiline_chart(config, json_data);
	});
});

</script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<div id="controls">
<fieldset>
<label>&nbsp;</label>
<label id="label_year_selector"><select id="year_selector">
<option value="4yr">4-Year Graduation Rate</option>
<option value="6yr" selected>6-Year Graduation Rate</option>
</select></label>

<label id="label_campus_selector"> for <select id="campus_selector">
<option value="Bakersfield">Bakersfield</option>
<option value="Channel Islands">Channel Islands</option>
<option value="Chico">Chico</option>
<option value="Dominguez Hills">Dominguez Hills</option>
<option value="East Bay">East Bay</option>
<option value="Fresno">Fresno</option>
<option value="Fullerton">Fullerton</option>
<option value="Humboldt">Humboldt</option>
<option value="Long Beach">Long Beach</option>
<option value="Los Angeles">Los Angeles</option>
<option value="Maritime Academy">Maritime Academy</option>
<option value="Monterey Bay">Monterey Bay</option>
<option value="Northridge">Northridge</option>
<option value="Pomona">Pomona</option>
<option value="Sacramento">Sacramento</option>
<option value="San Bernardino">San Bernardino</option>
<option value="San Diego">San Diego</option>
<option value="San Francisco">San Francisco</option>
<option value="San Jose">San Jose</option>
<option value="San Luis Obispo">San Luis Obispo</option>
<option value="San Marcos">San Marcos</option>
<option value="Sonoma">Sonoma</option>
<option value="Stanislaus">Stanislaus</option>
</select></label>

<select id="year_span_selector">
<option value="3">Past Three Years</option>
<option value="5">Past Five Years</option>
<option value="0">Full Data Series</option>
</select>

</fieldset>
</div>
<div id="chart_panel_0">
<div id="multiline_chart_container"></div>
<div id="text_panel_0">
<p>
Lorem ipsum dolor sit amet, pri an habemus inimicus, in sea putant consequat vituperata. Duo ferri accusamus in. Nemore appellantur consectetuer quo ei, no consul sanctus sea. Ea has affert quaerendum theophrastus.
</p><p>
Officiis pericula consequat mea ex, per porro munere evertitur ex. Diam quas quodsi et vel, qui eu tota epicurei pertinacia. Tale deleniti tacimates ex mei. Sit te illum facer numquam. Duo legere delectus consequuntur no, has in habeo platonem. Et dignissim necessitatibus duo. Vix ut voluptua delectus.
</p><p>
Cu sit alii mundi impetus. Ei sit error nominati praesent. Denique detraxit posidonium duo ne. Usu cu melius eripuit, partem viderer te vim. Sea eu illud platonem concludaturque, ad usu probatus convenire.
</p><p>
Mei at oblique hendrerit, eum ex luptatum periculis. Wisi choro cum ex, consulatu posidonium quo an. Vel libris aperiam laoreet no, elit quas mediocritatem nec ei. Ei mei veniam discere. Eu pri augue copiosae expetendis, ut solum prompta interpretaris sed. Tota volumus dissentias ad vis, nam alienum gloriatur ex.
</p><p>
Eu iisque dissentiet sit, eos possim vivendum te. Noster habemus quaestio eu qui, his errem feugiat no, populo aeterno admodum te vel. Duo iisque tamquam similique in. Quo cu quas nullam legere, fabellas comprehensam te sea.
</p>
</div>
</div>
</body></html>