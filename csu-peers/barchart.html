<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>CSU Peer Comparisons</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="assets/peercomp.css">
<style type="text/css">
${demo.css}
</style>
<script type="text/javascript">
$(function () {
	var update_chart = function (data) { 
		$('#container').highcharts({
		chart: {
		    type: 'column'
		},
		title: {
		    text: data.title //'Historical 6 Year Graduation Rate'
		},
		subtitle: {
		    text: data.subtitle //'2008 Cohort'
		},
		xAxis: {
		    type: 'category',
		    labels: {
			rotation: -45,
			style: {
			    fontSize: '13px',
			    fontFamily: 'Verdana, sans-serif'
			}
		    }
		},
		yAxis: {
		    title: {
		       text:  data.ylabel //'% Graduated'
		    }
		},
		legend: {
		    enabled: false
		},
		tooltip: {
		    pointFormat: 'Rate:{point.y:.1f}<br/>Comparison Type:6yr Grad Rate<br/>Cohort:2008<br/>Campus:{point.name}<br/>'
		},
		series: [{
		    data: data.series
		,
		   /* dataLabels: {
			enabled: true,
			rotation: -90,
			color: '#FFFFFF',
			align: 'right',
			format: '{point.y:.1f}', // one decimal
			y: 10, // 10 pixels down from the top
			style: {
			    fontSize: '13px',
			    fontFamily: 'Verdana, sans-serif'
			}
		    }*/
		}]
		});
	};
	var campus = 'Bakersfield'; // 'San Luis Obispo'
	var grad_year = '6yr'; // '4yr'
	var type = 'GR'; // 'Gap'
	var cohort = '2008'; // '2000'
	var load_chart_data = function (config, callback) {
		var chart_data_src = 'data/' + config.type + config.grad_year + '/' + config.campus.replace(/ /g,'_') + '_' + config.grad_year + config.type + '.json?v=3';
		if (chart_data_src !== config.current_src) {
			$.ajax({url:chart_data_src,datatype:"json",success:function (result) {
				console.log(JSON.parse(result));
				var json = JSON.parse(result);
				callback(json,config.campus,config.grad_year.slice(0,1),config.cohort);
			},failure:function (error) {console.log(error);}});
		}
	};
	var chart_grade_rate = function (json,campus,grad_year,cohort) {
		var cohort2col = {'2000':1,'2001':2,'2002':3,'2003':4,'2004':5,'2005':6,'2006':7,'2007':8,'2008':9}
		var row,col,key,value,data = {'title':'','ylabel':'','series':[],'tooltip':[]};
		col = cohort2col[cohort];
		data.title = 'Historical ' + grad_year + ' Year Graduation Rate';
		data.subtitle = cohort + ' Cohort'
		data.ylabel = '% Graduated';
		console.log(json);
		for (var i = 0, ilen = json.rows.length; i < ilen; i++) {
			row = json.rows[i];
			key = row[0].replace('California State University','CSU');
			value = parseFloat(row[col]);
			data.series[i] = {'name':key,'y':value};
			if (key.indexOf(campus) !== -1) {
				data.series[i] = {'name':key,'y':value,'color':'#663355'};
			}
			// Exception, should just check against a white-list of CSU campus names
			if (campus === 'Maritime Academy' && key.indexOf('California') === -1) {
				data.series[i] = {'name':key,'y':value};
			}
			data.tooltip[i] = '';
		}
		data.series = data.series.sort(function (b,a) {return a.y - b.y;});
		update_chart(data);
	};
	// initially display chart with default data
	load_chart_data({'campus':campus,'grad_year':grad_year,'type':type,'cohort':cohort,'current_src':''},chart_grade_rate);

	var campus_selector = document.querySelector('#campus_selector');
		campus_selector.addEventListener('change',function (e) {
		campus = e.target.value;
		load_chart_data({'campus':campus,'grad_year':grad_year,'type':type,'cohort':cohort,'current_src':''},chart_grade_rate);
		console.log(e.target.value);
	},false);

	var cohort_selector = document.querySelector('#cohort_selector');
	cohort_selector.addEventListener('change',function (e) {
		cohort = e.target.value;
		load_chart_data({'campus':campus,'grad_year':grad_year,'type':type,'cohort':cohort,'current_src':''},chart_grade_rate);
	},false);

	var year_selector = document.querySelector('#year_selector');
	year_selector.addEventListener('change',function (e) {
		grad_year = e.target.value;
		load_chart_data({'campus':campus,'grad_year':grad_year,'type':type,'cohort':cohort,'current_src':''},chart_grade_rate);
		console.log(e.target.value);
	},false);

});
</script></head><body>
<h1>CSU Peer Comparisons</h1>

<fieldset class="controls">
<label>Grad Year <select id="year_selector">
<option value="4yr">4th Year</option>
<option value="6yr" selected>6th Year</option>
</select></label>

<!-- <label>CSU Peer Institutions Comparison Reports for <select> -->
<label>CSU Campus <select id="campus_selector">
<option value="Bakersfield">Bakersfield</option>
<option value="Channel Islands">Channel Islands</option>
<option value="Dominguez Hills">Dominguez Hills</option>
<option value="East Bay">East Bay</option>
<option value="Fresno">Fresno</option>
<option value="Fullerton">Fullerton</option>
<option value="Humboldt">Humboldt</option>
<option value="Long Beach">Long Beach</option>
<option value="Los Angeles">Los Angeles</option>
<option value="Maritime Academy">Maritime Academy</option>
<option value="Monterey Bay">Monterey Bay</option>
<option value="Northridge">Northridge</option>
<option value="Pomona">Pomona</option>
<option value="Sacramento">Sacramento</option>
<option value="San Bernardino">San Bernardino</option>
<option value="San Diego">San Diego</option>
<option value="San Francisco">San Francisco</option>
<option value="San Jose">San Jose</option>
<option value="San Marcos">San Marcos</option>
<option value="Sonoma">Sonoma</option>
<option value="Stanislaus">Stanislaus</option>
</select></label>

<label>Cohort <select id="cohort_selector">
<option value="2008">2008</option>
<option value="2007">2007</option>
<option value="2006">2006</option>
<option value="2005">2005</option>
<option value="2004">2004</option>
<option value="2003">2003</option>
<option value="2002">2002</option>
<option value="2001">2001</option>
<option value="2000">2000</option>
</select></label>
</fieldset>

<div id="tab_controls">
<div class="tabtab">Chart</div>
<div class="tabtab">Table</div>
</div>
<script src="assets/highcharts.js"></script>
<div id="tab_0">
<div id="container" style="min-width: 300px; height: 400px; margin: 0 auto"></div>
<p class="footnote">
Peer institutions are selected based on the methodology developed by College Results Online 
(for details <a href="//collegeresults.org/aboutthedata.aspx#section-5 " target="_blank">click here</a>).
</p>
</div>
<div id="tab_1">
<div class="descriptive">
<table class="desctable" id="desctable"></table>
</div>
<div class="descriptive overlay">
<table class="desctable" id="desctable2"></table>
</div>
<p class="footnote">*Data are suppressed where student counts (N) is less than 30.</p>
</div>
<script>
(function (doc) {
var forEach = function (array, callback, scope) {
	for (var i = 0, ilen = array.length; i < ilen; i++) {
		callback.call(scope, array[i], i, array);
	}
};
// cheap ajax for wireframe - TODO: replace with jquery or ?
var ajax_get = function (endpoint, callback) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function () {
		if (xhttp.readyState == 4 && xhttp.status == 200) {
			callback(xhttp.responseText);
		}
	};

	xhttp.open('GET',endpoint,true);
	xhttp.send();
};

// pubsub event routing
var pubsub = function () {};
pubsub.events = {}; // {'tab0_selected':{sub1:fn1,sub2:fn2}}
pubsub.sub = function (t,s,fn) { // t:type,s:subscriber
	if (!pubsub.events.hasOwnProperty(t)) {
		pubsub.events[t] = {};
	}
	pubsub.events[t][s] = fn;
};
pubsub.raise = function (t,args) {
	for (s in pubsub.events[t]) {
		if (pubsub.events[t].hasOwnProperty(s)) {
			pubsub.events[t][s](t,s,args);
		}
	}
};

// register for tab event
pubsub.sub('tab','switch_tabs',function (t,s,args) {
	// should probably do this by adding / removing 'class="tab_selected"'
	forEach(args[2],function (el,i,a) {
		doc.querySelector('#tab_' + i).style.zIndex = 0; // bury unselected tabs
		el.style.backgroundColor = '#999'; // uncolor unselected tabs
	});
	doc.querySelector('#tab_' + args[1]).style.zIndex = 10; // show selected tab body on top
	args[0].style.backgroundColor = '#79a'; // color selected tab
});

// listen for click on each tab
var tabs = doc.querySelectorAll('.tabtab');
forEach(tabs, function (el,i,a) {
	el.addEventListener('click',function (e) {
		pubsub.raise('tab',[el,i,tabs]);
	},false);
});

// js handles for some page elements
var container = doc.querySelector('#desctable');
var container2 = doc.querySelector('#desctable2'); // shadow container
// create table from json data
var create_table = function (text) {
	//console.log(campus_selector.value);
	var out, json = JSON.parse(text);
	out = '<thead><tr>';
	json.headers[0].forEach(function (item,i) {
		out += '<td>' + item + '</td>'; 
	});
	out += '</tr></thead><tbody>';
	json.rows.forEach(function (row,j) {
		out += '<tr>';
		row.forEach(function (item,i) {
			if (item === '-') {
				item = 'ds*';
			}
			if (i === 0 && (item === 'California State University-' + campus_selector.value || 
					item === 'California ' + campus_selector.value || 
					item === 'California State Polytechnic University-' + campus_selector.value || 
					item === campus_selector.value + ' State University')) {
				out += '<td style="font-weight:600">' + item + '</td>'; 
			} else {
				out += '<td>' + item + '</td>'; 
			}
		});
		out += '</tr>';
	});
	out += '</tbody>'
	container.innerHTML = out;
	container2.innerHTML = out; // shadow-overlay hack to get fixed heading TODO: replace with better solution
};

// if we assume the typical user is interested in only her campus
// then loading only that campus makes sense
// otherwise if typical user checks all campuses, then maybe one
// load of all campus data at once would be more better...

//per selection, use ajax to load appropriate json data to populate the table
var campus_selector = doc.querySelector('#campus_selector');
var format_campus_table_endpoint = function (campus_name) {
	return 'data/CamPeer/CamPeer_' + campus_name.replace(/ /g,'_') + '.json';
};
campus_selector.addEventListener('change',function (e) {
	ajax_get(format_campus_table_endpoint(e.target.value), create_table) ;
},false);
// load default campus via ajax 
ajax_get(format_campus_table_endpoint('Bakersfield'), create_table) ;

})(document);
</script>
</body></html>